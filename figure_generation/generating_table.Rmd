---
title: "generating_table"
author: "Chandler Sutherland"
date: '2022-08-25'
output: html_document
---

```{r}
library(tidyverse)
library(ggplot2)
library(openxlsx)
library(ggsignif)
library(ggpubr)
```


Read in the excel files 
```{r}
#load in NLR_table, which contains clustering derived from Chae 2020 and HV status Prighozin and Krasileva 2021 
NLR_table <- readxl::read_xlsx(path='C:\\Users\\chand\\Box Sync\\Krasileva_Lab\\Research\\chandler\\Krasileva Lab\\E14\\working_table.xlsx')

HV_count <- sum(NLR_table$HV == 1)
nHV_count <- sum(NLR_table$HV == 0)

paste("There are ", HV_count, "HV genes in my working table and ", nHV_count, " non-HV genes in my working table.")
```


```{r}
#per gene average % CpG methylation 
SRR17281085 <- readxl::read_xlsx(path="C://Users//chand//Box Sync//Krasileva_Lab//Research//chandler//Krasileva Lab//E14//e14_R//SRR17281085_per_gene_meth_count.xlsx", skip=2, col_names = c('Index', 'Chrom', 'Gene', 'mean_percent_methylation', 'count'))
SRR17281086 <- readxl::read_xlsx(path="C://Users//chand//Box Sync//Krasileva_Lab//Research//chandler//Krasileva Lab//E14//e14_R//SRR17281086_per_gene_meth_count.xlsx", skip=2, col_names = c('Index', 'Chrom', 'Gene', 'mean_percent_methylation', 'count'))
SRR17281087 <- readxl::read_xlsx(path="C://Users//chand//Box Sync//Krasileva_Lab//Research//chandler//Krasileva Lab//E14//e14_R//SRR17281087_per_gene_meth_count.xlsx", skip=2, col_names = c('Index', 'Chrom', 'Gene', 'mean_percent_methylation', 'count'))
SRR17281088 <- readxl::read_xlsx(path="C://Users//chand//Box Sync//Krasileva_Lab//Research//chandler//Krasileva Lab//E14//e14_R//SRR17281088_per_gene_meth_count.xlsx", skip=2, col_names = c('Index', 'Chrom', 'Gene', 'mean_percent_methylation', 'count'))

all_meth <- rbind(SRR17281085, SRR17281086, SRR17281087, SRR17281088) %>%
  group_by(Gene) %>% summarize(meth_percentage=mean(mean_percent_methylation))

all_meth
```


```{r}
#TPM 
TPM <- read.table("C:/Users/chand/Box Sync/Krasileva_Lab/Research/chandler/Krasileva Lab/E14/e14_R/tpm_matrix.csv", header=TRUE, sep=",", row.names=2)%>% dplyr::select(-X)

TPM_df <- TPM %>% mutate('mean' = rowMeans(TPM[1:4])) 
all_expression <- merge(TPM_df, all_meth, by.x=0, by.y='Gene', all=TRUE)
all_expression <- all_expression %>% mutate(log2_TPM = log2(all_expression$mean+1))

#have to manually set the unmappable genes, since they just look like 0 
unmappable <- c('AT1G58807', 'AT1G58848', 'AT1G59124', 'AT1G59218')

all_expression$log2_TPM[all_expression$Row.names %in% unmappable] <- NA   
all_expression$mean[all_expression$Row.names %in% unmappable] <- NA 
```


```{r}
#TE distance
TE_table <- read.table(file='C:/Users/chand/Box Sync/Krasileva_Lab/Research/chandler/Krasileva Lab/E14/e14_R/Atha_genes_with_TE_dist.tsv', header=1) %>% distinct()
#converte TE distance to kb 
TE <- merge(TE_table, all_expression, by.x = 'Gene', by.y='Row.names', all=TRUE) %>%
  mutate(te_dist = te_dist/1000)
```


```{r}
#clean and concentrate 
merged <- merge(TE, NLR_table, by='Gene', all=TRUE)
table <- merged %>% subset(select=c('Gene', 'HV', 'log2_TPM', 'meth_percentage', 'te_dist')) %>%
  mutate(HV=recode(HV, `0` = "non-hv", `1`="hv"))

table$HV[is.na(table$HV)]<-'all_genes'
table$HV <- factor(table$HV , levels=c("all_genes", "non-hv", "hv"))

table
HV_count <- sum(table$HV == 'hv')
nHV_count <- sum(table$HV == 'non-hv')
```

```{r}
write.xlsx(table, 'C:\\Users\\chand\\Box Sync\\Krasileva_Lab\\Research\\chandler\\Krasileva Lab\\E14\\all_gene_table.xlsx')
```

