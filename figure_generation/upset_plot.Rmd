---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(ggplot2)
library(openxlsx)
library(ComplexUpset)
library(ggsignif)
library(ggpubr)
library(ggrepel)
library(rstatix)
library(psych)
library(patchwork)
```
Goal: show that stratifying the data by subgroup does not impact differences in features 

```{r}
#read in the methylation, expression, and TE distance for all genes, filter to NLRs
all_gene_table <- readxl::read_xlsx(path="C:\\Users\\chand\\Box Sync\\Krasileva_Lab\\Research\\chandler\\Krasileva Lab\\E14\\all_gene_table.xlsx")
NLR_table <- all_gene_table %>% filter(HV != 'all_genes')

#read in the cluster information and N-term status 
cluster <- readxl::read_xlsx(path="C:\\Users\\chand\\Box Sync\\Krasileva_Lab\\Research\\chandler\\Krasileva Lab\\E14\\chae_2020_supplemental.xlsx")
table <- merge(NLR_table, cluster, by.x='Gene', by.y='gene', all.x=TRUE)
```

"There are  35 HV genes in my working table and  97  non-HV genes in my working table."

```{r}
# Create a dataframe with the column subgroup, which has clustered/singleton and CNL/TNL information 
alt <- table %>% 
  mutate(cluster=case_when(whyCluster=='similarity' ~ 'singleton', #removing exclusively similarity based clusters, only distance 
                           .default=cluster)) %>% 
  mutate(clustered=case_when(cluster!='singleton' ~ 'clustered', 
                             cluster=='singleton' ~ 'singleton', 
                             whyCluster=='similarity' ~ 'singleton')) %>%
  filter(Nterm %in% c('C', 'T')) %>% #remove X domain and RNLs 
  mutate(domain=case_match(Nterm, 'C' ~ 'CNL', 
                           'T' ~ 'TNL')) 

# add information missing from Chae 2020 classifications 
index <- which(alt$gene == 'AT4G19050')
alt[index, 2] = 'Chr4'
alt[index, 20] = 'singleton'
alt[index, 21] = 'CNL' 

alt <- alt %>% 
  pivot_longer(cols=c('clustered', 'domain'), values_to='subgroup') 


```


```{r}
alt$HV <- factor(alt$HV, levels=c('non-hv', 'hv'))


alt %>% arrange(subgroup, HV)

y_label <- expression('log'[2]*'(TPM)')


#build annotation df 
group_n <- alt %>% pull(subgroup) %>% unique() %>% length()
alt$subgroup <- factor(alt$subgroup, levels=c('singleton', 'clustered', 'CNL', 'TNL'))
p_val <- alt %>% compare_means(log2_TPM~HV, ., group.by='subgroup', paired=F, method='wilcox.test', p.adjust.method = 'BH') %>%
  arrange(subgroup, p.adj) %>% 
  unique() %>%
  mutate(x=seq(from=1, to=group_n)) %>% 
  mutate(y=9) %>% 
  mutate(stars=case_when(p.adj < .001 ~'***', 
                         p.adj >= .001 & p.adj < .01 ~ '**', 
                         p.adj >= .01 & p.adj < .05 ~ '*', 
                         p.adj > .05 ~ 'ns'
                         ))

alt %>% filter(!is.na(log2_TPM)) %>% group_by(HV, subgroup) %>% summarize(n=n())

expr_p <- alt %>% arrange(subgroup, HV) %>%
  ggplot()+
  introdataviz::geom_split_violin(aes(x=subgroup, y=log2_TPM, fill=HV), alpha=0.4, trim = T, scale="width", 
                                  lwd=0.30)+
  stat_summary(mapping=aes(x=subgroup, y=log2_TPM, fill=HV), fun = median, geom = "point", show.legend = F, shape=21, color='black',
               position = position_dodge(.225), size=1) +
  scale_fill_manual(values=c('#00BFC4',  '#F8766D'))+
  scale_color_manual(values=c('#00BFC4',  '#F8766D'))+
  theme_classic(base_size = 10)+
  ylab(y_label)+
  xlab('')+
  ylim(0, 9.5)+
  scale_x_discrete(breaks=c("singleton","clustered", "CNL", "TNL"),
        labels=c("singletons\nn=28,7", "clustered\nn=63,24", "CNLs\nn=30,12", "TNLs\nn=61,19"))+
  theme(legend.position='none', 
        text = element_text(size=10, family='sans'), 
        axis.text.y=element_text(size=10))+
  geom_text(data=p_val, 
            mapping=aes(x=x, y=y, label=stars),
            size = 10/.pt,
            show.legend=FALSE)

```

```{r}
p_val <- alt %>% compare_means(meth_percentage~HV, ., group.by='subgroup', paired=F, method='wilcox.test', p.adjust.method = 'BH') %>%
  arrange(subgroup, p.adj) %>% 
  unique() %>%
  mutate(x=seq(from=1, to=group_n)) %>% 
  mutate(y=90) %>% 
  mutate(stars=case_when(p.adj < .001 ~'***', 
                         p.adj >= .001 & p.adj < .01 ~ '**', 
                         p.adj >= .01 & p.adj < .05 ~ '*', 
                         p.adj > .05 ~ 'ns'
                         ))

#print sample sizes
alt %>% filter(!is.na(meth_percentage)) %>% group_by(HV, subgroup) %>% summarize(n=n())

meth_p <- alt %>% arrange(subgroup, HV) %>%
  ggplot()+
  introdataviz::geom_split_violin(aes(x=subgroup, y=meth_percentage, fill=HV), alpha=0.4, trim = TRUE, scale="width", 
                                  lwd=0.30)+
  stat_summary(mapping=aes(x=subgroup, y=meth_percentage, fill=HV), fun = median, geom = "point", show.legend = F, shape=21, color='black',
               position = position_dodge(.225), size=1) +
  scale_fill_manual(values=c('#00BFC4',  '#F8766D'))+
  scale_color_manual(values=c('#00BFC4',  '#F8766D'))+
  theme_classic(base_size = 10)+
  ylab('%CG Methylation')+
  ylim(0,100)+
  xlab('')+
  scale_x_discrete(breaks=c("singleton","clustered", "CNL", "TNL"),
        labels=c("singletons\nn=27,7", "clustered\nn=63,24", "CNLs\nn=29,12", "TNLs\nn=61,19"))+
  theme(legend.position='none', 
        text = element_text(size=10, family='sans'), 
        axis.text.y=element_text(size=10))+
  geom_text(data=p_val, 
            mapping=aes(x=x, y=y, label=stars),
            size = 10/.pt,
            show.legend=FALSE)
```
```{r}
p_val <- alt %>% compare_means(te_dist~HV, ., group.by='subgroup', paired=F, method='wilcox.test', p.adjust.method = 'BH') %>%
  arrange(subgroup, p.adj) %>% 
  unique() %>%
  mutate(x=seq(from=1, to=group_n)) %>% 
  mutate(y=34) %>% 
  mutate(stars=case_when(p.adj < .001 ~'***', 
                         p.adj >= .001 & p.adj < .01 ~ '**', 
                         p.adj >= .01 & p.adj < .05 ~ '*', 
                         p.adj > .05 ~ 'ns'
                         ))

te_p <- alt %>% arrange(subgroup, HV) %>%
  ggplot()+
  introdataviz::geom_split_violin(aes(x=subgroup, y=te_dist, fill=HV), alpha=0.4, trim = TRUE, scale="width", 
                                  lwd=0.30)+
  stat_summary(mapping=aes(x=subgroup, y=te_dist, fill=HV), fun = median, geom = "point", show.legend = F, shape=21, color='black',
               position = position_dodge(.225), size=1) +
  scale_fill_manual(values=c('#00BFC4',  '#F8766D'))+
  scale_color_manual(values=c('#00BFC4',  '#F8766D'))+
  theme_classic(base_size = 10)+
  ylab('TE Distance')+
  xlab('')+
  ylim(0, 38)+
  #ggtitle('Vegetative Tissue') +
  theme(legend.position='none', 
        text = element_text(size=10, family='sans'), 
        axis.text.y=element_text(size=10))+
  geom_text(data=p_val, 
            mapping=aes(x=x, y=y, label=stars),
            size = 10/.pt,
            show.legend=FALSE)+
  scale_x_discrete(breaks=c("all","singleton","clustered", "CNL", "TNL"),
        labels=c("all NLRs\nn=97,35", "singletons\nn=28,7", "clustered\nn=63,28", "CNLs\nn=30,16", "TNLs\nn=61,19"))


alt %>% group_by(HV, subgroup) %>% summarize(n=n())
split_upset <- expr_p+meth_p+te_p + plot_layout(guides='collect', ncol=1)
ggsave(filename='C:\\Users\\chand\\Box Sync\\Krasileva_Lab\\Research\\chandler\\Krasileva Lab\\E14\\e14_R\\final_figures\\upset_2.png', plot=split_upset, dpi='retina', width=90, height=110, units = 'mm')
```


