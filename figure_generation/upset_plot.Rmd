---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(ggplot2)
library(openxlsx)
library(ComplexUpset)
library(ggsignif)
library(ggpubr)
```
ComplexUpset: potentially using to display the data in new and interesting ways 
```{r}
#read in the methylation, expression, and TE distance for all genes, filter to NLRs
all_gene_table <- readxl::read_xlsx(path="C:\\Users\\chand\\Box Sync\\Krasileva_Lab\\Research\\chandler\\Krasileva Lab\\E14\\all_gene_table.xlsx")
NLR_table <- all_gene_table %>% filter(HV != 'all_genes')

#read in the cluster information and N-term status 
cluster <- readxl::read_xlsx(path="C:\\Users\\chand\\Box Sync\\Krasileva_Lab\\Research\\chandler\\Krasileva Lab\\E14\\chae_2020_supplemental.xlsx")
table <- merge(NLR_table, cluster, by.x='Gene', by.y='gene', all.x=TRUE)
```

First, prepare the dataset. UpSet expects a boolean vectors under an indicator column header 

```{r}
table$HV <- table$HV == 'hv'
table$`non-HV` <- table$HV == FALSE
table$CNL <- table$Nterm == 'C'
table$TNL <- table$Nterm == 'T'
table$clustered <- table$cluster_type != 'singleton'
table$singleton <- table$cluster_type == 'singleton'
#variables: HV, CNL, TNL, RNL, clustered 

sets = c('HV', 'non-HV', 'clustered', 'CNL', 'TNL')
rev(sets)
```
```{r}
table %>% group_by(HV, clustered) %>% summarize(n())

cont_table <- data.frame(clustered=c(29,68),singleton=c(6,29), row.names=c("hv","non-hv"))
chisq.test(cont_table, correct=FALSE)
fisher.test(cont_table)
```

Calculate the cluster membership 
```{r}
table %>% group_by(HV, TNL) %>% summarize(n())
```

Time to calculate the p value using an unpaired wilcoxon rank sum test: 
```{r}
intersections=list('HV', 'non-HV', 
                         c('HV', 'clustered'), 
                         c('non-HV', 'clustered'),
                         c('HV', 'CNL'), 
                         c('non-HV', 'CNL'),
                         c('HV', 'TNL'), 
                         c('non-HV', 'TNL') #, 
                      #   c('HV', 'clustered', 'CNL'), 
                     #    c('non-HV', 'clustered', 'CNL'),
                       #  c('HV', 'clustered', 'TNL'), 
                        # c('non-HV', 'clustered', 'TNL')
                         )
comparisons <- c('hv_nhv', 'clust', 'cnl', 'tnl')

#transcription 
hv_nhv <- compare_means(log2_TPM~HV, table, method='wilcox.test', paired=FALSE)$p 
clust <- compare_means(log2_TPM~HV, table %>% filter(clustered == TRUE), method='wilcox.test', paired=FALSE)$p 
cnl <- compare_means(log2_TPM~HV, table %>% filter(Nterm == 'C'), method='wilcox.test', paired=FALSE)$p
tnl <- compare_means(log2_TPM~HV, table %>% filter(Nterm == 'T'), method='wilcox.test', paired=FALSE)$p 

transcription_pval <- p.adjust(c(hv_nhv, clust, cnl, tnl), method='BH', 4)

#te_dist
a <- compare_means(te_dist~HV, table, method='wilcox.test', paired=FALSE)$p
b <- compare_means(te_dist~HV, table %>% filter(clustered == TRUE), method='wilcox.test', paired=FALSE)$p
c <- compare_means(te_dist~HV, table %>% filter(Nterm == 'C'), method='wilcox.test', paired=FALSE)$p
d <- compare_means(te_dist~HV, table %>% filter(Nterm == 'T'), method='wilcox.test', paired=FALSE)$p

te_dist_pval <- p.adjust(c(a, b, c, d ), method='BH', 4)

#methylation
g <- compare_means(meth_percentage~HV, table, method='wilcox.test', paired=FALSE)
h <- compare_means(meth_percentage~HV, table %>% filter(clustered == TRUE), method='wilcox.test', paired=FALSE)
i <- compare_means(meth_percentage~HV, table %>% filter(Nterm == 'C'), method='wilcox.test', paired=FALSE)
j <- compare_means(meth_percentage~HV, table %>% filter(Nterm == 'T'), method='wilcox.test', paired=FALSE)


meth_pval <- p.adjust(c(g, h, i, j ), method='BH', 4)

pval_table <- data.frame(comparisons, transcription_pval, meth_pval, te_dist_pval)
pval_table <- pval_table %>% mutate(transcription_stars = case_when(transcription_pval >= 0.05 ~ 'n.s.', 
                                                      transcription_pval < .05 & transcription_pval >= .01 ~ '*',
                                                      transcription_pval < .01 & transcription_pval >= .001 ~ '**',
                                                      transcription_pval < .001 & transcription_pval > 0 ~ '***')) %>%
  mutate(meth_stars = case_when(meth_pval >= 0.05 ~ 'n.s.', 
                                meth_pval < .05 & meth_pval >= .01 ~ '*',
                                meth_pval < .01 & meth_pval >= .001 ~ '**',
                                meth_pval < .001 & meth_pval > 0 ~ '***')) %>%
  mutate(te_stars = case_when(te_dist_pval >= 0.05 ~ 'n.s.', 
                                te_dist_pval < .05 & te_dist_pval >= .01 ~ '*',
                                te_dist_pval < .01 & te_dist_pval >= .001 ~ '**',
                                te_dist_pval < .001 & te_dist_pval > 0 ~ '***'))  


pval_table$transcription_pval <- pval_table$transcription_pval %>% as.character()
pval_table$meth_pval <- pval_table$meth_pval %>% as.character()
pval_table$te_dist_pval <- pval_table$te_dist_pval %>% as.character()
pval_table$transcription_stars

pval_table
```

Create the plot 
```{r}
p_upset2 <- upset(table, rev(sets), keep_empty_groups=TRUE, mode='inclusive_intersection', 
      sort_sets=FALSE,
      sort_intersections=FALSE, 
      intersections=list('non-HV', 'HV', 
                         c('non-HV', 'clustered'), 
                         c('HV', 'clustered'),
                         c('non-HV', 'CNL'), 
                         c('HV', 'CNL'),
                         c('non-HV', 'TNL'), 
                         c('HV', 'TNL')
                         ),
      annotations=list('log2(TPM)' = (
        ggplot(mapping=aes(y=log2_TPM))+
                         geom_violin(aes(fill=intersection), lwd=0.25) +
          ylim(0,9) +
          geom_signif(stat='identity', 
                      data=data.frame(x = c(1, 3, 5, 7),
                      xend=c(2, 4, 6, 8),
                      y = c(8, 8, 8, 8),
                      annotation1 = pval_table$transcription_stars, 
                      annotation2 = c('***', ' *** ', '  *  ', '*')), 
              aes(x=x, xend=xend, y=y, yend=y, annotation=annotation2, textsize=2.5))+
          theme(text=element_text(size=10), legend.position='none')+
        scale_fill_manual(values=c('#f9918a', '#33ccd0',  '#fbada7','#66d9dc',  '#F8766D','#00BFC4', '#c65e57','#00999d'))
        ),
        'TE distance' = (
        ggplot(mapping=aes(y=te_dist))+
          geom_violin(aes(fill=intersection), lwd=0.25, outlier.size=0.25)+
         # theme_classic()+
          theme(text=element_text(size=10), legend.position = 'none')+
          ylim(0, 38)+
          geom_signif(stat="identity", 
              data=data.frame(x = c(1, 3, 5, 7),
                              xend=c(2, 4, 6, 8),
                              y = c(34, 34, 34, 34),
                              annotation = c('***', ' *** ', '  **  ', '*')), 
              aes(x=x, xend=xend, y=y, yend=y, annotation=annotation, textsize=2.5), tip_length=0.1)+
        scale_fill_manual(values=c('#f9918a', '#33ccd0',  '#fbada7','#66d9dc',  '#F8766D','#00BFC4', '#c65e57','#00999d')))
        ,
  '%CG Methylation' = (
        ggplot(mapping=aes(y=meth_percentage))+
          geom_violin(aes(fill=intersection), lwd=0.25)+
        #  theme_classic()+
        theme(text=element_text(size=10), legend.position = 'none')+
          ylim(0, 100)+
        geom_signif(stat="identity", 
              data=data.frame(x = c(1, 3, 5, 7),
                              xend=c(2, 4, 6, 8),
                              y = c(90, 90, 90, 90),
                              annotation = c('**', 'n.s.', '  *  ', ' n.s. ')), 
              aes(x=x, xend=xend, y=y, yend=y, annotation=annotation, textsize=2.5))+
        scale_fill_manual(values=c('#f9918a', '#33ccd0',  '#fbada7','#66d9dc',  '#F8766D','#00BFC4', '#c65e57','#00999d'))
        )),   
  themes=upset_default_themes(text=element_text(size=8), 
                              plot.background = element_blank(), 
                              axis.line=element_blank(), 
                            #  panel.grid.major = element_blank(), 
                              panel.grid.minor = element_blank()),
   base_annotations=list(), 
  set_sizes=FALSE, 
  matrix=(intersection_matrix(segment=geom_segment(linewidth=0.5), 
                              geom=geom_point(size=1.5)) 
  ))

p_upset2 <- p_upset2 + patchwork::plot_layout(heights=c(1, 1, 1, .75))
ggsave(filename='C:\\Users\\chand\\Box Sync\\Krasileva_Lab\\Research\\chandler\\Krasileva Lab\\E14\\e14_R\\final_figures\\upset_sig_wilcoxon.png', plot=p_upset2, dpi='retina', width=4.5, height=6.25)
```

```{r}
p_upset2 <- p_upset2 + patchwork::plot_layout(heights=c(0.75, 0.75, 0.75, 0.75, 1.15))
ggsave(filename='C:\\Users\\chand\\Box Sync\\Krasileva_Lab\\Research\\chandler\\Krasileva Lab\\E14\\e14_R\\final_figures\\upset_sig_longer.png', plot=p_upset2, dpi='retina', width=5, height=5.25)
```

```{r}
table %>% group_by(HV, TNL) %>% summarize(n=n())
```

