---
title: "Confounding variable analysis by Stratification"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE)
```

Copyright (c) Chandler Sutherland Email: [chandlersutherland\@berkeley.edu](mailto:chandlersutherland@berkeley.edu){.email}

Purpose: investigate potential confounding factors by using data stratification and repeating pairwise comparisons.

Intermediate processing steps are shown here, and figures can be recreated using just the numerical source data provided in `Source Data/Figure 3/3A`.

```{r}
library(tidyverse)
library(ggplot2)
library(openxlsx)
library(ggsignif)
library(ggpubr)
library(ggrepel)
library(patchwork)
```

```{r}
#Change to your path to the zenodo download to repeat 
zenodo_path <- "C:\\Users\\chand\\Box Sync\\Krasileva_Lab\\Research\\chandler\\Krasileva Lab\\E14\\Zenodo V2\\"

#load in all gene data, filter to NLRs 
NLR_table <- read.csv(paste(zenodo_path, 'NLR_gene_table.csv')) %>% subset(select=-c(X, `...1`)) %>%
  dplyr::rename('common_name'='name')
```

Create a dataframe with the column subgroup, which has clustered/singleton and CNL/TNL information

```{r}
alt <- NLR_table %>%
  filter(Nterm %in% c('C', 'T')) %>% #remove RNL and XNLs
  mutate(domain=case_match(Nterm, 'C' ~ 'CNL', 
                           'T' ~ 'TNL'))
```

Fisher test of independence between HV status, cluster status, and domain status

```{r}
cont_table <- alt %>% 
  group_by(HV, clustered) %>% 
  summarize(n=n()) %>% 
  pivot_wider(names_from = c('clustered'), values_from='n') %>% 
  column_to_rownames('HV') %>% 
  as.matrix()
fisher.test(cont_table)

cont_table2 <- alt %>% 
  group_by(HV, domain) %>% 
  summarize(n=n()) %>% 
  pivot_wider(names_from = c('domain'), values_from='n') %>% 
  column_to_rownames('HV') %>% 
  as.matrix()
fisher.test(cont_table2)
```

HV status and cluster status are independent, and HV status and domain are independent.

```{r}
#write/read source Data 
write.csv(alt, file="./Source Data/Figure 3/3A/NLR_feature_by_strata.csv")
#read in source data 
#alt <- read.csv("./Source Data/Figure 3/3A/NLR_feature_by_strata.csv")
```

## Expression stratification

Apply Benjamini-Hochberg correction across strata to account for multiple testing

```{r expr_strat}
#pivot for easier stratification 
pivot_alt <- alt %>% 
  pivot_longer(cols=c('clustered', 'domain'), values_to='subgroup') 

pivot_alt$HV <- factor(pivot_alt$HV, levels=c('non-hv', 'hv'))
y_label <- expression('log'[2]*'(TPM)')


#build annotation df 
group_n <- pivot_alt %>% pull(subgroup) %>% unique() %>% length()
pivot_alt$subgroup <- factor(pivot_alt$subgroup, levels=c('singleton', 'clustered', 'CNL', 'TNL'))
p_val <- pivot_alt %>% compare_means(log2_TPM~HV, ., group.by='subgroup', paired=F, method='wilcox.test', p.adjust.method = 'BH') %>%
  arrange(subgroup, p.adj) %>% 
  unique() %>%
  mutate(x=seq(from=1, to=group_n)) %>% 
  mutate(y=9) %>% 
  mutate(stars=case_when(p.adj < .001 ~'***', 
                         p.adj >= .001 & p.adj < .01 ~ '**', 
                         p.adj >= .01 & p.adj < .05 ~ '*', 
                         p.adj > .05 ~ 'ns'
                         ))
p_val 

pivot_alt %>% filter(!is.na(log2_TPM)) %>% group_by(HV, subgroup) %>% summarize(n=n())

expr_p <- pivot_alt %>% arrange(subgroup, HV) %>%
  ggplot()+
  introdataviz::geom_split_violin(aes(x=subgroup, y=log2_TPM, fill=HV), alpha=0.4, trim = T, scale="width", 
                                  lwd=0.30)+
  stat_summary(mapping=aes(x=subgroup, y=log2_TPM, fill=HV), fun = median, geom = "point", show.legend = F, shape=21, color='black',
               position = position_dodge(.225), size=1) +
  scale_fill_manual(values=c('#00BFC4',  '#F8766D'))+
  scale_color_manual(values=c('#00BFC4',  '#F8766D'))+
  theme_classic(base_size = 10)+
  ylab(y_label)+
  xlab('')+
  ylim(0, 9.5)+
  scale_x_discrete(breaks=c("singleton","clustered", "CNL", "TNL"),
        labels=c("singletons\nn=34,12", "clustered\nn=57,19", "CNLs\nn=30,12", "TNLs\nn=61,19"))+
  theme(legend.position='none', 
        text = element_text(size=10, family='sans'), 
        axis.text.y=element_text(size=10))+
  geom_text(data=p_val, 
            mapping=aes(x=x, y=y, label=stars),
            size = 10/.pt,
            show.legend=FALSE)
```

## Methylation Stratification

```{r meth_strat}
p_val <- pivot_alt %>% 
  compare_means(meth_percentage~HV, ., group.by='subgroup', paired=F, method='wilcox.test', p.adjust.method = 'BH') %>%
  arrange(subgroup, p.adj) %>% 
  unique() %>%
  mutate(x=seq(from=1, to=group_n)) %>% 
  mutate(y=90) %>% 
  mutate(stars=case_when(p.adj < .001 ~'***', 
                         p.adj >= .001 & p.adj < .01 ~ '**', 
                         p.adj >= .01 & p.adj < .05 ~ '*', 
                         p.adj > .05 ~ 'ns'
                         ))
p_val 

#print sample sizes
pivot_alt %>% filter(!is.na(meth_percentage)) %>% group_by(HV, subgroup) %>% summarize(n=n())

meth_p <- pivot_alt %>% arrange(subgroup, HV) %>%
  ggplot()+
  introdataviz::geom_split_violin(aes(x=subgroup, y=meth_percentage, fill=HV), alpha=0.4, trim = TRUE, scale="width", 
                                  lwd=0.30)+
  stat_summary(mapping=aes(x=subgroup, y=meth_percentage, fill=HV), fun = median, geom = "point", show.legend = F, shape=21, color='black',
               position = position_dodge(.225), size=1) +
  scale_fill_manual(values=c('#00BFC4',  '#F8766D'))+
  scale_color_manual(values=c('#00BFC4',  '#F8766D'))+
  theme_classic(base_size = 10)+
  ylab('%CG Methylation')+
  ylim(0,100)+
  xlab('')+
  scale_x_discrete(breaks=c("singleton","clustered", "CNL", "TNL"),
        labels=c("singletons\nn=33,12", "clustered\nn=57,19", "CNLs\nn=29,12", "TNLs\nn=61,19"))+
  theme(legend.position='none', 
        text = element_text(size=10, family='sans'), 
        axis.text.y=element_text(size=10))+
  geom_text(data=p_val, 
            mapping=aes(x=x, y=y, label=stars),
            size = 10/.pt,
            show.legend=FALSE)
```

## TE distance stratification

```{r te_strat}
p_val <- pivot_alt %>% compare_means(te_dist~HV, ., group.by='subgroup', paired=F, method='wilcox.test', p.adjust.method = 'BH') %>%
  arrange(subgroup, p.adj) %>% 
  unique() %>%
  mutate(x=seq(from=1, to=group_n)) %>% 
  mutate(y=34) %>% 
  mutate(stars=case_when(p.adj < .001 ~'***', 
                         p.adj >= .001 & p.adj < .01 ~ '**', 
                         p.adj >= .01 & p.adj < .05 ~ '*', 
                         p.adj > .05 ~ 'ns'
                         ))

p_val 

te_p <- pivot_alt %>% arrange(subgroup, HV) %>%
  ggplot()+
  introdataviz::geom_split_violin(aes(x=subgroup, y=te_dist, fill=HV), alpha=0.4, trim = TRUE, scale="width", 
                                  lwd=0.30)+
  stat_summary(mapping=aes(x=subgroup, y=te_dist, fill=HV), fun = median, geom = "point", show.legend = F, shape=21, color='black',
               position = position_dodge(.225), size=1) +
  scale_fill_manual(values=c('#00BFC4',  '#F8766D'))+
  scale_color_manual(values=c('#00BFC4',  '#F8766D'))+
  theme_classic(base_size = 10)+
  ylab('TE Distance')+
  xlab('')+
  ylim(0, 38)+
  theme(legend.position='none', 
        text = element_text(size=10, family='sans'), 
        axis.text.y=element_text(size=10))+
  geom_text(data=p_val, 
            mapping=aes(x=x, y=y, label=stars),
            size = 10/.pt,
            show.legend=FALSE)+
  scale_x_discrete(breaks=c("singleton","clustered", "CNL", "TNL"),
        labels=c("singletons\nn=34,13", "clustered\nn=57,22", "CNLs\nn=30,16", "TNLs\nn=61,19"))


pivot_alt %>% group_by(HV, subgroup) %>% summarize(n=n())
```

# Figure 3A: split violin plots by strata

```{r split_upset}
split_upset <- expr_p+meth_p+te_p + plot_layout(guides='collect', ncol=1)
split_upset
ggsave(filename='C:\\Users\\chand\\Box Sync\\Krasileva_Lab\\Research\\chandler\\Krasileva Lab\\Outputs\\NLR Features Paper\\EMBO Submission\\Figure Panels\\fig_3a.svg', plot=split_upset, dpi=1000, width=80, height=110, units = 'mm')
```

Statistics for within hv and within non-hv differences across strata

```{r}
#are the distributions between hv and non-hv different across strata? 
kruskal.test(log2_TPM~subgroup, data=(pivot_alt %>% filter(HV=='non-hv')))
kruskal.test(log2_TPM~subgroup, data=(pivot_alt %>% filter(HV=='hv')))

kruskal.test(meth_percentage~subgroup, data=(pivot_alt %>% filter(HV=='non-hv')))
kruskal.test(meth_percentage~subgroup, data=(pivot_alt %>% filter(HV=='hv')))

kruskal.test(te_dist~subgroup, data=(pivot_alt %>% filter(HV=='non-hv')))
kruskal.test(te_dist~subgroup, data=(pivot_alt %>% filter(HV=='hv')))

p.adjust(c(0.8705, 0.04255, 0.5573), method='BH')
p.adjust(c(0.345, 0.6333, 0.619), method='BH')
```

Nope, subseting the hv and non-hv groups does not change distribution across strata.
